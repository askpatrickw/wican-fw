name: Build Vehicle Profiles

on:
  push:
    branches:
      - main
    paths:
      - 'vehicle_profiles/**'
      - '.vehicle_profiles/**'
      - '.github/workflows/vehicle_profiles.yml'

jobs:
  build:
    # Avoid infinite loop on the auto-generated commit
    if: "!contains(github.event.head_commit.message, 'Build Vehicle Profiles')"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history so we can rebase
          persist-credentials: true
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - name: Sync with latest main (rebase)
        run: |
          git fetch origin main
          # If we are behind, rebase; if up-to-date, this is a no-op
          git pull --rebase origin main || {
            echo 'Rebase failed';
            exit 1;
          }
      - run: |
          cd .vehicle_profiles
          npm ci
          npm run build
          npx prettier ../vehicle_profiles --write
          npx prettier . --write
          cd -
      - name: Commit
        uses: EndBug/add-and-commit@v9
        with:
          add: 'vehicle_profiles.json docs/content/0.Config/6.Automate/2.Supported_Vehicles.md vehicle_profiles/ .vehicle_profiles/'
          author_name: Jay Oswald
          author_email: jay@oswald.net.au
          message: Commit from GitHub Actions (Build Vehicle Profiles)
          pull: '--rebase --autostash'
          push: true
